- let description = get_page_fill_description()

- let ai = page.ai
- let randomNum = theme.post_head_ai_description.randomNum
- let basicWordCount = theme.post_head_ai_description.basicWordCount
- let btnLink = theme.post_head_ai_description.btnLink
- let gptName = theme.post_head_ai_description.gptName
- let mode = theme.post_head_ai_description.mode
- let switchBtn = theme.post_head_ai_description.switchBtn
if (description && ai)
  .post-ai-description
    .ai-title
      i.fa-brands.fa-bilibili
      .ai-title-text AI-æ‘˜è¦
      if (switchBtn)
        #ai-Toggle åˆ‡æ¢
      i.fas.fa-arrow-right
      #ai-tag
        if mode == "tianli"
          = "Tianli GPT"
        else
          = gptName + " GPT"
    .ai-explanation AIåˆå§‹åŒ–ä¸­...
    .ai-btn-box
      .ai-btn-item ä»‹ç»è‡ªå·± ğŸ™ˆ
      .ai-btn-item ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ ğŸ‘‹
      .ai-btn-item æ¨èç›¸å…³æ–‡ç«  ğŸ“–
      .ai-btn-item å‰å¾€ä¸»é¡µ ğŸ 
      .ai-btn-item#go-tianli-blog å‰å¾€tianliåšå®¢
    script(data-pjax).
      (function(){
        // å½“å‰éšæœºåˆ°çš„aiæ‘˜è¦åˆ°index
        let lastAiRandomIndex = -1;
        let animationRunning = true; // æ ‡å¿—å˜é‡ï¼Œæ§åˆ¶åŠ¨ç”»å‡½æ•°çš„è¿è¡Œ
        // å½“å‰gptæ¨¡å¼
        let mode = "#{mode}"
        // åˆ·æ–°ç‚¹å‡»æ¬¡æ•°
        let refreshNum = 0
        // è®°å½•ä¸Šä¸€æ¬¡ä¼ é€’ç»™aiAbstractçš„å‚æ•°
        let prevParam;
        const aiTitleRefreshIcon = document.querySelector(".ai-title .fas.fa-arrow-right")
        const explanation = document.querySelector(".ai-explanation");
        const post_ai = document.querySelector(".post-ai-description");
        let ai_str = "";
        let ai_str_length = "";
        let delay_init = 600;
        let i = 0;
        let j = 0;
        let sto = [];
        let elapsed = 0;
        const animate = timestamp => {
          if (!animationRunning) {
            return; // åŠ¨ç”»å‡½æ•°åœæ­¢è¿è¡Œ
          }
          if (!animate.start) animate.start = timestamp;
          elapsed = timestamp - animate.start;
          if (elapsed >= 20) {
            animate.start = timestamp;
            if (i < ai_str_length - 1) {
              let char = ai_str.charAt(i + 1);
              let delay = /[,.ï¼Œã€‚!?ï¼ï¼Ÿ]/.test(char) ? 150 : 20;
              if (explanation.firstElementChild) {
                explanation.removeChild(explanation.firstElementChild);
              }
              explanation.innerHTML += char;
              let div = document.createElement("div");
              div.className = "ai-cursor";
              explanation.appendChild(div);
              i++;
              if (delay === 150) {
                document.querySelector(".ai-explanation .ai-cursor").style.opacity = "0";
              }
              if (i === ai_str_length - 1) {
                observer.disconnect(); // æš‚åœç›‘å¬
                explanation.removeChild(explanation.firstElementChild);
              }
              sto[0] = setTimeout(() => {
                requestAnimationFrame(animate);
              }, delay);
            }
          } else {
            requestAnimationFrame(animate);
          }
        };
        const observer = new IntersectionObserver(
          entries => {
            let isVisible = entries[0].isIntersecting;
            animationRunning = isVisible; // æ ‡å¿—å˜é‡æ›´æ–°
            if (animationRunning) {
              delay_init = i === 0 ? 200 : 20;
              sto[1] = setTimeout(() => {
                if (j) {
                  i = 0;
                  j = 0;
                }
                if (i === 0) {
                  explanation.innerHTML = ai_str.charAt(0);
                }
                requestAnimationFrame(animate);
              }, delay_init);
            }
          },
          { threshold: 0 }
        );
        function clearSTO() {
          if (sto.length) {
            sto.forEach(item => {
              if (item) {
                clearTimeout(item);
              }
            });
          }
        }
        function startAI(str, df = true) {
          i = 0; //é‡ç½®è®¡æ•°å™¨
          j = 1;
          clearSTO();
          animationRunning = false;
          elapsed = 0;
          observer.disconnect(); // æš‚åœä¸Šä¸€æ¬¡ç›‘å¬
          explanation.innerHTML = df ? "ç”Ÿæˆä¸­. . ." : "è¯·ç­‰å¾…. . .";
          ai_str = str;
          ai_str_length = ai_str.length;
          observer.observe(post_ai); //å¯åŠ¨æ–°ç›‘å¬
        }

        async function aiAbstract(num = #{basicWordCount}) {
          i = 0; //é‡ç½®è®¡æ•°å™¨
          j = 1;
          clearSTO();
          animationRunning = false;
          elapsed = 0;
          observer.disconnect(); // æš‚åœä¸Šä¸€æ¬¡ç›‘å¬
          if (mode === "tianli") {
            num = Math.max(10, Math.min(2000, num));
            const options = {
              key: "#{theme.post_head_ai_description.key}",
              Referer: "#{theme.post_head_ai_description.Referer}"
            };
            const truncateDescription = ("#{pageTitle.replace(/<\/?[^>]+>|&|:|;|quot;|ï¼Œ|,|â€œ|â€|"|'|#/g, "")}" + "#{description}").trim().substring(0, num)

            const queryParams = `key=${options.key}&content=${truncateDescription}`;
            const requestOptions = {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Referer: options.Referer
              },
            };
            try {
              let animationInterval = null
              if (animationInterval) clearInterval(animationInterval);
              animationInterval = setInterval(() => {
                const animationText = "ç”Ÿæˆä¸­" + ".".repeat(j);
                explanation.innerHTML = animationText;
                j = (j % 3) + 1; // åœ¨ 1ã€2ã€3 ä¹‹é—´å¾ªç¯
              }, 500);
              const response = await fetch(`https://summary.tianli0.top/?${queryParams}`, requestOptions);
              let result;
              if (response.status === 403) {
                result = {
                  summary: "403 referä¸keyä¸åŒ¹é…ï¼Œæœ¬åœ°æ— æ³•æ˜¾ç¤ºã€‚"
                }
              } else if (response.status === 500) {
                result = {
                  summary: "500 ç³»ç»Ÿå†…éƒ¨é”™è¯¯"
                }
              } else {
                result = await response.json();
              }
              const summary = result.summary.trim();
              setTimeout(() => {
                aiTitleRefreshIcon.style.opacity = "1";
              }, 300)
              startAI(summary);
              clearInterval(animationInterval)
            } catch (error) {
              console.error(error);
              explanation.innerHTML = "å‘ç”Ÿå¼‚å¸¸" + error;
            }
          } else {
            const strArr = "#{ai}".split(",").map(item => item.trim()); // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°ç»„ï¼Œå»é™¤æ¯ä¸ªå­—ç¬¦ä¸²å‰åçš„ç©ºæ ¼
            if (strArr.length !== 1) {
              let randomIndex = Math.floor(Math.random() * strArr.length); // éšæœºç”Ÿæˆä¸€ä¸ªç´¢å¼•
              while (randomIndex === lastAiRandomIndex) { // å¦‚æœéšæœºåˆ°äº†ä¸Šæ¬¡çš„ç´¢å¼•
                randomIndex = Math.floor(Math.random() * strArr.length); // å†æ¬¡éšæœº
              }
              lastAiRandomIndex = randomIndex; // æ›´æ–°ä¸Šæ¬¡éšæœºåˆ°çš„ç´¢å¼•
              startAI(strArr[randomIndex]);
            } else {
              startAI(strArr[0])
            }
            setTimeout(() => {
              aiTitleRefreshIcon.style.opacity = "1";
            }, 600)
          }
        }

        function aiRecommend() {
          i = 0; //é‡ç½®è®¡æ•°å™¨
          j = 1;
          clearSTO();
          animationRunning = false;
          elapsed = 0;
          explanation.innerHTML = "ç”Ÿæˆä¸­. . .";
          ai_str = "";
          ai_str_length = "";
          observer.disconnect(); // æš‚åœä¸Šä¸€æ¬¡ç›‘å¬
          sto[2] = setTimeout(() => {
            explanation.innerHTML = recommendList();
          }, 600);
        }
        function aiGoHome() {
          startAI("æ­£åœ¨å‰å¾€åšå®¢ä¸»é¡µ...", false);
          sto[2] = setTimeout(() => {
            pjax.loadUrl("/");
          }, 1000);
        }
        const ai_btn_item = document.querySelectorAll(".ai-btn-item");
        function Introduce() {
          if (mode == "tianli") {
            startAI("æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: TianliGPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚")
          } else {
            startAI("æˆ‘æ˜¯æ–‡ç« è¾…åŠ©AI: #{gptName} GPTï¼Œç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®ï¼Œè®©æˆ‘ç”Ÿæˆæœ¬æ–‡ç®€ä»‹ã€æ¨èç›¸å…³æ–‡ç« ç­‰ã€‚")
          }
        }
        function aiTitleRefreshIconClick() {
          aiTitleRefreshIcon.click()
        }
        const aiFunctions = [Introduce, aiTitleRefreshIconClick, aiRecommend, aiGoHome];
        ai_btn_item.forEach((item, index) => {
          item.addEventListener("click", () => {
            aiFunctions[index]();
          });
        });

        function recommendList() {
          let thumbnail = document.querySelectorAll('.relatedPosts-list a');
          if (!thumbnail.length) {
            const cardRecentPost = document.querySelector('.card-widget.card-recent-post'); 
            if (!cardRecentPost) return '';

            thumbnail = cardRecentPost.querySelectorAll('.aside-list-item a');

            let list = '';
            for (let i = 0; i < thumbnail.length; i++) {
              const item = thumbnail[i];
              list += `<div class="ai-recommend-item"><span class="index">${i + 1}ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
            }
            
            return `å¾ˆæŠ±æ­‰ï¼Œæ— æ³•æ‰¾åˆ°ç±»ä¼¼çš„æ–‡ç« ï¼Œä½ ä¹Ÿå¯ä»¥çœ‹çœ‹æœ¬ç«™æœ€æ–°å‘å¸ƒçš„æ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
          }

          let list = '';
          for (let i = 0; i < thumbnail.length; i++) {
            const item = thumbnail[i];
            list += `<div class="ai-recommend-item"><span>æ¨è${i + 1}ï¼š</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
          }

          return `æ¨èæ–‡ç« ï¼š<br /><div class="ai-recommend">${list}</div>`;
        }


        function changeShowMode() {
          if (mode === "tianli") {
            mode = "local";
            document.getElementById("ai-tag").innerHTML = "#{gptName} GPT";
            aiAbstract(#{basicWordCount});
          } else {
            mode = "tianli";
            document.getElementById("ai-tag").innerHTML = "Tianli GPT";

            const truncateDescription = ("#{title}" + "#{description}").trim().substring(0, #{basicWordCount});
            let value = Math.floor(Math.random() * #{randomNum}) + #{basicWordCount};
            while (value === prevParam || truncateDescription.length - value === prevParam) {
              value = Math.floor(Math.random() * #{randomNum}) + #{basicWordCount};
            }
            aiTitleRefreshIcon.style.opacity = "0.2";
            aiTitleRefreshIcon.style.transitionDuration = "0.3s";
            aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
            if (truncateDescription.length <= 1000) {
              let param = truncateDescription.length - Math.floor(Math.random() * #{randomNum});
              while (param === prevParam) {
                param = truncateDescription.length - Math.floor(Math.random() * #{randomNum});
              }
              aiAbstract(param);
              prevParam = param;
            } else {
              aiAbstract(value);
              prevParam = value;
            }
            refreshNum++;
          }
        }

        //- ç›‘å¬tagç‚¹å‡»äº‹ä»¶
        document.getElementById("ai-tag").addEventListener("click", () => {
          if (mode === "tianli") {
            document.querySelectorAll(".ai-btn-item").forEach(item => item.style.display = "none");
            document.getElementById("go-tianli-blog").style.display = "block";
            startAI("ä½ å¥½ï¼Œæˆ‘æ˜¯Tianliå¼€å‘çš„æ‘˜è¦ç”ŸæˆåŠ©ç†TianliGPTï¼Œæ˜¯ä¸€ä¸ªåŸºäºGPT-4çš„ç”Ÿæˆå¼AIã€‚æˆ‘åœ¨è¿™é‡Œåªè´Ÿè´£æ‘˜è¦çš„é¢„ç”Ÿæˆå’Œæ˜¾ç¤ºï¼Œä½ æ— æ³•ä¸æˆ‘ç›´æ¥æ²Ÿé€šï¼Œå¦‚æœä½ ä¹Ÿéœ€è¦ä¸€ä¸ªè¿™æ ·çš„AIæ‘˜è¦æ¥å£ï¼Œå¯ä»¥åœ¨ä¸‹æ–¹è´­ä¹°ã€‚ï¼ˆæš‚æœªå¼€æ”¾è´­ä¹°ï¼Œæ•¬è¯·æœŸå¾…ï¼‰")
          } else {
            document.getElementById("go-tianli-blog").style.display = "none";
            startAI("ä½ å¥½ï¼Œæˆ‘æ˜¯æœ¬ç«™æ‘˜è¦ç”ŸæˆåŠ©ç†#{gptName} GPTï¼Œæ˜¯ä¸€ä¸ªåŸºäºGPT-4çš„ç”Ÿæˆå¼AIã€‚æˆ‘åœ¨è¿™é‡Œåªè´Ÿè´£æ‘˜è¦çš„é¢„ç”Ÿæˆå’Œæ˜¾ç¤ºï¼Œä½ æ— æ³•ä¸æˆ‘ç›´æ¥æ²Ÿé€šã€‚")
          }

        });

        aiTitleRefreshIcon.addEventListener("click", () => {
          const truncateDescription = ("#{title}" + "#{description}").trim().substring(0, #{basicWordCount});
          let value = Math.floor(Math.random() * #{randomNum}) + #{basicWordCount};
          while (value === prevParam || truncateDescription.length - value === prevParam) {
            value = Math.floor(Math.random() * #{randomNum}) + #{basicWordCount};
          }
          aiTitleRefreshIcon.style.opacity = "0.2";
          aiTitleRefreshIcon.style.transitionDuration = "0.3s";
          aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
          if (truncateDescription.length <= #{basicWordCount}) {
            let param = truncateDescription.length - Math.floor(Math.random() * #{randomNum});
            while (param === prevParam) {
              param = truncateDescription.length - Math.floor(Math.random() * #{randomNum});
            }
            aiAbstract(param);
            prevParam = param;
          } else {
            aiAbstract(value);
            prevParam = value;
          }
          showAiBtn();
          refreshNum++;
        });

        document.getElementById("go-tianli-blog").addEventListener("click", () => {
          window.open("#{btnLink}", "_blank");
        });
        
        if (#{switchBtn}) {
          document.getElementById("ai-Toggle").addEventListener("click", () => {
            changeShowMode()
          });
        }

        function showAiBtn() {
          document.querySelectorAll(".ai-btn-item").forEach(item => {
            if (item.id !== "go-tianli-blog") {
              item.style.display = "block";
            }
            if (item.id === "go-tianli-blog") {
              item.style.display = "none";
            }
          });
        }


        aiAbstract();
        showAiBtn()
      })()